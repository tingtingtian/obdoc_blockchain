![[EVM 执行中的异常情况.png]]

### **EVM 执行中的异常情况**

	以太坊虚拟机（EVM）在执行智能合约时，可能会遇到多种异常。这些异常会导致当前的执行停止，并触发回滚机制（Revert）。图中展示了 EVM 执行的不同组件以及可能的异常触发点，以下是详细说明：

##### **1. PC（程序计数器，Program Counter）异常**

	• 异常类型：invalid jump destination
	• 含义：
		• 程序计数器（PC）指向的是下一个要执行的字节码指令。
		• 如果 PC 跳转到了一个无效的位置（例如，指向一段没有定义的代码），EVM 会抛出 invalid jump destination 异常。
	• 原因：
		• 合约代码的字节码中包含非法的 JUMP 或 JUMPDEST。
		• 开发时，逻辑错误导致程序试图访问不可到达的代码段。
	• 结果：
		• 执行回滚，调用合约失败。
		
##### **2. Gas 可用性异常**

	• 异常类型：out-of-gas
	• 含义：
		• EVM 执行每个操作指令（opcode）都需要消耗 Gas。
		• 如果调用过程中 Gas 不足以完成下一步操作，则会抛出 out-of-gas 异常。
	• 原因：
		• 用户在交易中提供的 Gas 不足以覆盖操作成本。
		• 递归调用或循环中消耗了过多 Gas。
	• 结果：
		• EVM 回滚所有状态更改，但仍然扣除所有已消耗的 Gas。

##### **3. Stack 异常**
	• 异常类型：stack underflow
	• 含义：
		• EVM 中的栈用于存储操作数和临时数据，栈操作（如 PUSH、POP）需要遵循栈深限制。
		• 如果执行时试图弹出（POP）栈，但栈中没有足够的数据，则抛出 stack underflow 异常。
	• 原因：
		• 指令试图访问栈中的元素，但栈为空。
		• 合约代码逻辑有误，未正确初始化栈。
	• 结果：
		• 执行失败，EVM 回滚。

##### **4. Opcode（操作码）异常**
	• 异常类型：invalid instruction
	• 含义：
		• EVM 执行合约代码中的操作码（opcode）。
		• 如果遇到未定义的 opcode 或非法指令，则抛出 invalid instruction 异常。
	• 原因：
		• 合约代码中包含了未定义或非法的指令。
		• 代码被篡改或不完整。
	• 结果：
		• EVM 停止执行，并回滚所有状态更改。

##### **5. Memory 和 Storage 访问问题**

	• Memory：
		• 内存操作需要严格的范围检查，例如不能访问超出分配范围的内存区域。
		• 如果指令试图访问未初始化的内存或非法地址，可能导致执行异常。
		
	• Storage：
		• 存储空间用于存储合约的永久状态。
		• 写入存储的操作需要消耗大量 Gas，如果 Gas 不足或逻辑错误，可能导致异常。

### **异常的处理机制**

##### 1. **状态回滚**

	• 如果出现任何异常，EVM 会回滚当前交易或调用中已进行的所有状态更改（即保持区块链的状态一致性）。

##### 2. **Gas 的处理**

	• 即使发生异常，调用者已经消耗的 Gas 也不会退还。

##### 3. **异常传播**

	• 如果一个合约调用另一个合约，并且被调用合约中发生异常，则异常会传播回调用者。
	• 开发者可以通过 try/catch 捕获并处理异常（Solidity 0.6.0 及以后支持）。


### **总结**

	EVM 中的异常（如上图所示）主要涉及程序计数器、Gas 供应、栈操作、内存访问及指令执行。通过严格限制和处理这些异常，EVM 保证了智能合约执行的安全性和一致性。这也是开发智能合约时需要特别注意 Gas 限制、逻辑边界检查的重要原因。