	以太坊虚拟机（EVM）的 指令集（Instruction Set） 是一个用于执行智能合约的低级指令集合。这些指令以 操作码（opcodes） 的形式表示，每个操作码对应一个操作（如算术运算、逻辑运算、内存操作等）。指令集设计简单但功能强大，支持 Turing 完整性，使得开发者可以用 Solidity 等高级语言编写合约，然后通过编译器转换为 EVM 字节码（bytecode）。

以下是对 EVM 指令集的详细介绍：

### **1. 指令集的分类**

  EVM 指令集可以分为以下几个类别：
##### **1.1. 停止和算术操作**

	• 功能：执行程序停止和基本算术运算。
	• 常见指令：
		• STOP：停止执行。
		• ADD：两个数相加。
		• MUL：两个数相乘。
		• SUB：两个数相减。
		• DIV：两个数相除（整数除法）。
		• MOD：取模运算。
		• EXP：指数运算。
		• SIGNEXTEND：符号扩展。
##### **1.2. 比较和位操作**

	• 功能：执行比较运算和位操作。
	• 常见指令：
	• 比较操作：
		• LT：小于（less than）。
		• GT：大于（greater than）。
		• EQ：等于（equal）。
		• ISZERO：检查是否为零。
	• 位操作：
		• AND：按位与。
		• OR：按位或。
		• XOR：按位异或。
		• NOT：按位取反。
		• SHL：左移位。
		• SHR：右移位（逻辑）。
		• SAR：右移位（算术）。
##### **1.3. 环境信息**

	• 功能：获取当前交易和区块的上下文信息。
	• 常见指令：
	• 交易信息：
		• CALLER：获取当前调用者的地址。
		• CALLVALUE：获取当前调用附带的以太币数量。
		• CALLDATALOAD：从调用数据中加载值。
		• CALLDATASIZE：获取调用数据大小。
		• CALLDATACOPY：复制调用数据到内存。

	• 区块信息：
		• BLOCKHASH：获取指定区块的哈希值。
		• COINBASE：获取当前区块的矿工地址。
		• TIMESTAMP：获取当前区块的时间戳。
		• NUMBER：获取当前区块号。
		• DIFFICULTY：获取当前区块的难度。
		• GASLIMIT：获取当前区块的 Gas 限制。

	• 合约状态：
		• ADDRESS：获取当前合约地址。
		• BALANCE：获取某地址的余额。
		• SELFBALANCE：获取当前合约的余额。
		• ORIGIN：获取交易发起者的地址。

##### **1.4. 存储、内存和堆栈操作**

	• 功能：操作 EVM 的存储、内存和堆栈。
	• 常见指令：
		• 堆栈操作：
			• PUSHn：将 n 字节的值压入堆栈（如 PUSH1, PUSH32）。
			• POP：弹出堆栈顶部的值。
			• DUPn：复制堆栈中第 n 个值到顶部（如 DUP1, DUP16）。
			• SWAPn：交换堆栈顶部的值与第 n 个值（如 SWAP1, SWAP16）。
		• 内存操作：
			• MLOAD：从内存加载值。
			• MSTORE：将值存储到内存。
			• MSTORE8：将 1 字节的值存储到内存。
		• 存储操作：
			• SLOAD：从存储中加载值。
			• SSTORE：将值存储到存储中。

##### **1.5. 流程控制**

	• 功能：管理程序的执行流程。
	• 常见指令：
		• JUMP：跳转到指定指令位置。
		• JUMPI：条件跳转。
		• PC：获取当前程序计数器（Program Counter）。
		• JUMPDEST：定义跳转目标。
##### **1.6. 调用、创建和销毁合约**
	• 功能：管理合约之间的交互。
	• 常见指令：
		• 合约调用：
			• CALL：调用另一个合约。
			• CALLCODE：调用另一个合约的代码（但保留当前上下文）。
			• DELEGATECALL：以当前调用者的上下文执行另一个合约的代码。
			• STATICCALL：静态调用，不允许修改状态。
		• 合约创建与销毁：
			• CREATE：创建一个新的合约。
			• CREATE2：通过特定地址创建合约。
			• SELFDESTRUCT：销毁当前合约并发送余额。

##### **1.7. 哈希计算**
	• 功能：执行哈希计算。
	• 常见指令：
		• SHA3（也叫 KECCAK256）：对内存中的数据进行 Keccak-256 哈希计算。

##### **1.8. 日志记录**
	• 功能：生成事件日志。
	• 常见指令：
		• LOG0：生成没有主题的日志。
		• LOG1 到 LOG4：生成包含 1 到 4 个主题的日志。
##### **1.9. 错误和终止**

	• 功能：处理错误和程序终止。
	• 常见指令：
		• REVERT：回滚当前交易并返回错误消息。
		• RETURN：返回函数执行结果。
		• INVALID：无效操作，通常用于占位。
		• SELFDESTRUCT：销毁合约并发送余额。
##### **1.10. Gas 相关操作**

	• 功能：管理和查询 Gas 使用情况。
	• 常见指令：
	• GAS：获取剩余 Gas。
	• GASPRICE：获取当前交易的 Gas 价格。
	• BASEFEE：获取当前区块的 Base Fee。
	• EXTCODEHASH：获取合约代码的哈希值。

### **2. 执行特点**

##### • **栈式架构**
	• EVM 是基于栈的虚拟机，指令操作数和结果都存储在栈中。
	• 栈的大小限制为 1024 个元素，每个元素为 256 位。

##### • **每条指令消耗 Gas**

	• 每条指令都需要消耗一定的 Gas，复杂指令消耗更多 Gas。
	• 如果 Gas 不足，程序会触发 Out-of-Gas 异常，回滚交易。

##### • **Turing 完整性**

	• 指令集设计支持循环和条件跳转，使得 EVM 成为 Turing 完整的计算模型。

  

### **3. 示例：指令执行流程**

假设我们调用一个简单的智能合约函数：

```
function add(uint256 a, uint256 b) public pure returns (uint256) {
    return a + b;
}
```

**EVM 执行的字节码**

编译后的字节码可能如下：
```
PUSH1 0x60
PUSH1 0x40
MSTORE
PUSH1 0x20
PUSH1 0x00
ADD
```

1. PUSH1：将常量压入堆栈。
2. MSTORE：将堆栈顶部的值存入内存。
3. ADD：弹出两个值相加，将结果压入堆栈。

最终结果通过 RETURN 返回。


### **4. 总结**

	EVM 指令集是以太坊智能合约的核心，通过一组简单的操作码支持智能合约的编写和执行。开发者需要理解这些指令及其分类，尤其是在调试合约、优化 Gas 消耗或分析低级操作时，EVM 指令集是关键所在。